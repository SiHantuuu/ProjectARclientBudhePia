<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>AR Joystick Mode</title>

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: black;
      }

      /* 1. LAYER VIDEO KAMERA (Paling Belakang) */
      #webcam-video {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: -1; /* Di belakang canvas 3D */
        transform: scaleX(-1); /* Mirror biar kayak cermin (opsional) */
      }

      /* 2. LAYER JOYSTICK */
      #joystick-zone {
        position: absolute;
        bottom: 20px;
        left: 20px;
        width: 150px;
        height: 150px;
        z-index: 999;
        touch-action: none;
      }

      /* 3. UI INSTRUKSI & INFO */
      #instruction {
        position: fixed;
        top: 10px;
        width: 100%;
        text-align: center;
        color: #00ffea;
        font-family: sans-serif;
        font-weight: bold;
        text-shadow: 2px 2px 2px black;
        pointer-events: none;
        z-index: 900;
      }

      #info-overlay {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        max-width: 350px;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 20px;
        border-radius: 15px;
        border: 2px solid #00d2ff;
        z-index: 1000;
        font-family: sans-serif;
        text-align: center;
      }
      .close-btn {
        background: #ff4444;
        color: white;
        border: none;
        padding: 10px 20px;
        margin-top: 15px;
        border-radius: 50px;
        font-weight: bold;
        cursor: pointer;
      }

      /* Tombol Start Camera (Kalo auto-play diblokir browser) */
      #start-cam-btn {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 15px 30px;
        background: #ff6b00;
        color: white;
        border: none;
        font-size: 18px;
        border-radius: 30px;
        z-index: 2000;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <video id="webcam-video" autoplay playsinline muted></video>

    <button id="start-cam-btn" onclick="startCamera()">
      üì∑ AKTIFKAN KAMERA
    </button>

    <div id="instruction">
      üïπÔ∏è Pakai Joystick Kiri untuk Jalan | üëã Geser Layar untuk Nengok
    </div>

    <div id="joystick-zone"></div>

    <div id="info-overlay">
      <h2 id="info-title" style="color: #00d2ff">Judul</h2>
      <p id="info-desc">Deskripsi...</p>
      <button class="close-btn" onclick="tutupInfo()">TUTUP</button>
    </div>

    <a-scene
      vr-mode-ui="enabled: false"
      renderer="alpha: true; antialias: true"
      cursor="rayOrigin: mouse"
      raycaster="objects: .clickable"
    >
      <a-assets>
        <a-asset-item
          id="model-bebek"
          src="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb"
        ></a-asset-item>
      </a-assets>

      <a-entity id="rig" position="0 0 4">
        <a-entity
          id="camera"
          camera
          look-controls="touchEnabled: true"
          position="0 1.6 0"
        ></a-entity>
      </a-entity>

      <a-light type="directional" position="-1 2 1" intensity="2"></a-light>
      <a-light type="ambient" intensity="1"></a-light>

      <a-entity
        class="clickable"
        gltf-model="#model-bebek"
        position="0 0 0"
        scale="1 1 1"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear"
        onclick="bukaInfo('Bebek AR', 'Bebek ini melayang di dunia nyata! Ganti dengan pelampung.glb kamu.')"
      >
      </a-entity>

      <a-grid
        helper
        geometry="primitive: plane; width: 20; height: 20"
        rotation="-90 0 0"
        position="0 -1 0"
        material="src: url(https://cdn.aframe.io/a-painter/images/floor.jpg); opacity: 0.3; transparent: true; repeat: 10 10"
      >
      </a-grid>

      <a-entity position="-2 0.5 -2">
        <a-torus
          class="clickable"
          color="orange"
          radius="0.5"
          radius-tubular="0.15"
          onclick="bukaInfo('Pelampung', 'Pelampung di samping kiri.')"
        ></a-torus>
        <a-text value="PELAMPUNG" position="-0.5 1 0" color="yellow"></a-text>
      </a-entity>
    </a-scene>

    <script>
      /* --- 1. SCRIPT KAMERA REAL --- */
      async function startCamera() {
        const video = document.getElementById("webcam-video");
        const btn = document.getElementById("start-cam-btn");

        try {
          // Minta akses kamera belakang (environment)
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
            audio: false,
          });
          video.srcObject = stream;
          btn.style.display = "none"; // Sembunyikan tombol
        } catch (err) {
          alert("Gagal akses kamera: " + err);
          // Fallback untuk testing di laptop (kalo gak ada kamera belakang)
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: true,
            });
            video.srcObject = stream;
            btn.style.display = "none";
          } catch (e) {
            alert("Kamera benar-benar tidak bisa dibuka.");
          }
        }
      }

      /* --- 2. SCRIPT JOYSTICK (Sama seperti sebelumnya) --- */
      const joystickZone = document.getElementById("joystick-zone");
      const manager = nipplejs.create({
        zone: joystickZone,
        mode: "static",
        position: { left: "50%", top: "50%" },
        color: "white",
        size: 100,
      });

      let moveData = { x: 0, y: 0 };
      let isMoving = false;
      const speed = 0.1;

      manager.on("move", function (evt, data) {
        if (data && data.vector) {
          moveData.x = data.vector.x;
          moveData.y = data.vector.y;
          isMoving = true;
        }
      });
      manager.on("end", function () {
        isMoving = false;
        moveData = { x: 0, y: 0 };
      });

      const rig = document.getElementById("rig");
      const camera = document.getElementById("camera");

      function gameLoop() {
        if (isMoving) {
          const rotation = camera.getAttribute("rotation");
          const angleRad = rotation.y * (Math.PI / 180);
          const dx = Math.sin(angleRad) * -moveData.y * speed;
          const dz = Math.cos(angleRad) * -moveData.y * speed;
          const sx = Math.cos(angleRad) * moveData.x * speed;
          const sz = Math.sin(angleRad) * -moveData.x * speed;
          rig.object3D.position.x += dx + sx;
          rig.object3D.position.z += dz + sz;
        }
        requestAnimationFrame(gameLoop);
      }
      gameLoop();

      /* --- 3. UI INFO --- */
      const infoOverlay = document.getElementById("info-overlay");
      const titleEl = document.getElementById("info-title");
      const descEl = document.getElementById("info-desc");

      window.bukaInfo = function (judul, deskripsi) {
        titleEl.innerText = judul;
        descEl.innerText = deskripsi;
        infoOverlay.style.display = "block";
      };
      window.tutupInfo = function () {
        infoOverlay.style.display = "none";
      };

      joystickZone.addEventListener(
        "touchmove",
        function (e) {
          e.stopPropagation();
        },
        false
      );
    </script>
  </body>
</html>
