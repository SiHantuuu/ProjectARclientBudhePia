<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MES Simulation â€“ Single Scene Demo</title>

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: sans-serif;
        user-select: none;
      }

      /* START SCREEN */
      #start-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 99999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
      }
      #start-btn {
        padding: 20px 50px;
        font-size: 24px;
        background: #00d2ff;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-weight: bold;
        margin-top: 20px;
        transition: 0.3s;
      }
      #start-btn:hover {
        background: white;
        transform: scale(1.1);
      }

      /* HUD & INFO */
      #info-overlay {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        max-width: 400px;
        background: rgba(10, 10, 10, 0.95);
        padding: 30px;
        color: white;
        border: 2px solid #00d2ff;
        border-radius: 10px;
        text-align: center;
        z-index: 10000;
      }
      .close-btn {
        margin-top: 20px;
        padding: 10px 30px;
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }

      /* Update HUD: Lebih bersih tanpa list scene */
      #controls-hud {
        position: fixed;
        bottom: 20px;
        left: 20px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 14px;
        pointer-events: none;
        background: rgba(0, 0, 0, 0.5);
        padding: 10px;
        border-radius: 8px;
        border-left: 3px solid #00d2ff;
      }

      #crosshair {
        position: fixed;
        top: 50%;
        left: 50%;
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
        z-index: 5000;
        opacity: 0.8;
      }
      #crosshair.active {
        background: #00d2ff;
        transform: translate(-50%, -50%) scale(2);
      }

      #interact-msg {
        position: fixed;
        top: 55%;
        left: 50%;
        transform: translate(-50%, 0);
        color: #00d2ff;
        font-weight: bold;
        text-shadow: 1px 1px 2px black;
        display: none;
        pointer-events: none;
      }

      /* NAVIGATION - Masih ada tapi statis */
      #nav-info {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        padding: 10px 20px;
        border-radius: 20px;
        border: 1px solid #00d2ff;
        font-weight: bold;
      }

      /* JOYSTICK (Mobile) */
      #joystick-zone {
        position: absolute;
        bottom: 50px;
        right: 50px;
        width: 120px;
        height: 120px;
        z-index: 999;
        display: none;
      }
      @media (max-width: 768px) {
        #joystick-zone {
          display: block;
        }
        #controls-hud {
          display: none;
        }
      }
    </style>
  </head>

  <body>
    <div id="start-screen">
      <h1>SIMULASI MES</h1>
      <p>Gunakan Mouse & WASD. Tekan E untuk Interaksi.</p>
      <button id="start-btn">MASUK SIMULASI</button>
    </div>

    <div id="crosshair"></div>
    <div id="interact-msg">TEKAN [E]</div>
    <div id="nav-info">Loc: Bridge (Anjungan)</div>

    <div id="controls-hud">
      <div><b>WASD</b> Gerak | <b>MOUSE</b> Lihat | <b>E</b> Interaksi</div>
    </div>

    <div id="info-overlay">
      <h2 id="info-title"></h2>
      <p id="info-desc"></p>
      <button class="close-btn" onclick="closePopup()">TUTUP</button>
    </div>

    <div id="joystick-zone"></div>

    <a-scene loading-screen="dotsColor: red; backgroundColor: black">
      <a-assets>
        <a-mixin
          id="box-interactive"
          geometry="primitive: box"
          material="opacity: 0.8; transparent: true"
        ></a-mixin>
      </a-assets>

      <a-entity id="rig" position="0 0 5">
        <a-entity
          id="camera"
          camera
          look-controls="pointerLockEnabled: true"
          position="0 1.6 0"
        >
          <a-entity
            raycaster="objects: .clickable; far: 4; interval: 100"
            position="0 0 -1"
            geometry="primitive: ring; radiusInner: 0.001; radiusOuter: 0.001"
            material="color: black; shader: flat"
            id="cam-ray"
          >
          </a-entity>
        </a-entity>
      </a-entity>

      <a-plane
        rotation="-90 0 0"
        width="100"
        height="100"
        color="#1a1a1a"
      ></a-plane>
      <a-sky color="#050505"></a-sky>
      <a-light type="ambient" color="#444"></a-light>
      <a-light type="point" position="2 4 4" intensity="0.5"></a-light>

      <a-entity id="scene-bridge"></a-entity>
      <a-entity id="scene-deck" visible="false"></a-entity>
      <a-entity id="scene-mes" visible="false"></a-entity>
      <a-entity id="scene-chute" visible="false"></a-entity>
      <a-entity id="scene-liferaft" visible="false"></a-entity>
    </a-scene>

    <script>
      /* --- 1. DATA --- */
      const items = {
        alarm: {
          t: "General Alarm",
          d: "Bunyikan alarm untuk memanggil semua kru ke Muster Station.",
        },
        phone: {
          t: "Emergency Phone",
          d: "Gunakan untuk melapor ke anjungan atau kamar mesin.",
        },
        jacket: {
          t: "Life Jacket",
          d: "Pakai Life Jacket, kencangkan tali, jangan sampai longgar.",
        },
        muster: {
          t: "Muster Station",
          d: "Tempat berkumpul semua kru untuk absen (Head Count).",
        },
        mes: {
          t: "MES Container",
          d: "Unit MES (Marine Evacuation System). Tarik handle untuk rilis.",
        },
        chute: {
          t: "Chute Entry",
          d: "Lompat masuk dengan posisi kaki menyilang agar tidak tersangkut.",
        },
        raft: {
          t: "Liferaft",
          d: "Potong tali painter hanya jika kapal benar-benar akan tenggelam.",
        },
      };

      /* --- 2. SETUP OBJECTS --- */
      function addObj(sceneId, pos, col, key) {
        const el = document.createElement("a-entity");
        el.setAttribute("geometry", "primitive: box");
        el.setAttribute("material", "color", col);
        el.setAttribute("position", pos);
        el.setAttribute("class", "clickable");
        el.dataset.key = key;
        document.getElementById(sceneId).appendChild(el);
      }

      // Generate Objects (Semua di-load, tapi user cuma bisa lihat Bridge)
      addObj("scene-bridge", "0 1 -3", "#ff4444", "alarm");
      addObj("scene-bridge", "2 1 -3", "#ffaa00", "phone");
      addObj("scene-deck", "-2 1 -3", "#ff8800", "jacket");
      addObj("scene-deck", "2 1 -3", "#00d2ff", "muster");
      addObj("scene-mes", "0 1 -3", "#aa44ff", "mes");
      addObj("scene-chute", "0 1 -3", "#44ffaa", "chute");
      addObj("scene-liferaft", "0 1 -3", "#33ff77", "raft");

      /* --- 3. LOGIC START --- */
      const startBtn = document.getElementById("start-btn");
      const startScreen = document.getElementById("start-screen");

      startBtn.addEventListener("click", function () {
        startScreen.style.display = "none";
        const sceneEl = document.querySelector("a-scene");
        if (sceneEl.canvas) sceneEl.canvas.requestPointerLock();
      });

      document.querySelector("a-scene").addEventListener("click", function () {
        if (!isPopupOpen) {
          const sceneEl = document.querySelector("a-scene");
          if (sceneEl.canvas) sceneEl.canvas.requestPointerLock();
        }
      });

      /* --- 4. INTERACTION SYSTEM --- */
      let focusedItem = null;
      let isPopupOpen = false;
      const ray = document.getElementById("cam-ray");
      const crosshair = document.getElementById("crosshair");
      const msg = document.getElementById("interact-msg");
      const popup = document.getElementById("info-overlay");

      ray.addEventListener("raycaster-intersection", (evt) => {
        if (isPopupOpen) return;
        const el = evt.detail.els[0];
        if (el && el.dataset.key) {
          focusedItem = items[el.dataset.key];
          crosshair.classList.add("active");
          msg.style.display = "block";
          msg.innerText = "TEKAN [E] : " + focusedItem.t;
        }
      });

      ray.addEventListener("raycaster-intersection-cleared", () => {
        focusedItem = null;
        crosshair.classList.remove("active");
        msg.style.display = "none";
      });

      function showPopup() {
        if (!focusedItem) return;
        document.getElementById("info-title").innerText = focusedItem.t;
        document.getElementById("info-desc").innerText = focusedItem.d;
        popup.style.display = "block";
        isPopupOpen = true;
        document.exitPointerLock();
      }

      window.closePopup = function () {
        popup.style.display = "none";
        isPopupOpen = false;
        document.querySelector("a-scene").canvas.requestPointerLock();
      };

      /* --- 5. CONTROLS (FITUR GANTI SCENE DIMATIKAN) --- */
      const keys = { w: false, a: false, s: false, d: false };

      window.addEventListener("keydown", (e) => {
        const k = e.key.toLowerCase();
        if (keys.hasOwnProperty(k)) keys[k] = true;

        // INTERAKSI
        if (k === "e" && !isPopupOpen && focusedItem) showPopup();
        if (k === "escape") closePopup();

        /* FITUR GANTI SCENE (1-5) DINONAKTIFKAN SEMENTARA
           (Code block dihapus agar user fokus di scene 1)
        */
      });

      window.addEventListener("keyup", (e) => {
        const k = e.key.toLowerCase();
        if (keys.hasOwnProperty(k)) keys[k] = false;
      });

      /* --- 6. MOVEMENT LOOP --- */
      const rig = document.getElementById("rig");
      const cam = document.getElementById("camera");
      let joyData = null;

      const joy = nipplejs.create({
        zone: document.getElementById("joystick-zone"),
        mode: "static",
        position: { right: "50%", bottom: "50%" },
        color: "white",
      });
      joy.on("move", (e, data) => {
        joyData = data.vector;
      });
      joy.on("end", () => {
        joyData = null;
      });

      function loop() {
        if (!isPopupOpen) {
          const rotY = cam.object3D.rotation.y;
          const speed = 0.1;
          let dx = 0,
            dz = 0;

          if (keys.w) dz -= 1;
          if (keys.s) dz += 1;
          if (keys.a) dx -= 1;
          if (keys.d) dx += 1;

          if (joyData) {
            dx = joyData.x;
            dz = -joyData.y;
          }

          if (dx !== 0 || dz !== 0) {
            rig.object3D.position.x +=
              (Math.cos(rotY) * dx - Math.sin(rotY) * dz) * speed;
            rig.object3D.position.z +=
              (Math.sin(rotY) * dx + Math.cos(rotY) * dz) * speed;
          }
        }
        requestAnimationFrame(loop);
      }
      loop();
    </script>
  </body>
</html>
