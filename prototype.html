<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MES Simulation â€“ Final Scene 1, 2, & 3</title>

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: sans-serif;
        user-select: none;
      }

      /* UI ELEMENTS */
      #start-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 99999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
      }
      #start-btn {
        padding: 20px 50px;
        font-size: 24px;
        background: #00d2ff;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-weight: bold;
        margin-top: 20px;
        transition: 0.3s;
      }
      #start-btn:hover {
        background: white;
        transform: scale(1.1);
      }

      #info-overlay {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        max-width: 400px;
        background: rgba(10, 10, 10, 0.95);
        padding: 30px;
        color: white;
        border: 2px solid #00d2ff;
        border-radius: 10px;
        text-align: center;
        z-index: 10000;
      }
      .close-btn {
        margin-top: 20px;
        padding: 10px 30px;
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }

      #controls-hud {
        position: fixed;
        bottom: 20px;
        left: 20px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 14px;
        pointer-events: none;
        background: rgba(0, 0, 0, 0.5);
        padding: 10px;
        border-radius: 8px;
        border-left: 3px solid #00d2ff;
      }

      #crosshair {
        position: fixed;
        top: 50%;
        left: 50%;
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
        z-index: 5000;
        opacity: 0.8;
      }
      #crosshair.active {
        background: #00d2ff;
        transform: translate(-50%, -50%) scale(2);
      }

      #interact-msg {
        position: fixed;
        top: 55%;
        left: 50%;
        transform: translate(-50%, 0);
        color: #00ff00;
        font-weight: bold;
        font-size: 18px;
        text-shadow: 1px 1px 2px black;
        display: none;
        pointer-events: none;
        background: rgba(0, 0, 0, 0.7);
        padding: 5px 10px;
        border-radius: 5px;
      }

      #nav-info {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        padding: 10px 20px;
        border-radius: 20px;
        border: 1px solid #00d2ff;
        font-weight: bold;
      }

      /* JOYSTICK (Mobile) */
      #joystick-zone {
        position: absolute;
        bottom: 50px;
        right: 50px;
        width: 120px;
        height: 120px;
        z-index: 999;
        display: none;
      }
      @media (max-width: 768px) {
        #joystick-zone {
          display: block;
        }
        #controls-hud {
          display: none;
        }
      }
    </style>
  </head>

  <body>
    <div id="start-screen">
      <h1>SIMULASI MES - FINAL</h1>
      <p>Tekan angka <b>1</b>, <b>2</b>, atau <b>3</b> untuk ganti Scene.</p>
      <button id="start-btn">MASUK SIMULASI</button>
    </div>

    <div id="crosshair"></div>
    <div id="interact-msg"></div>
    <div id="nav-info">Loc: Loading...</div>

    <div id="controls-hud">
      <div>
        <b>WASD</b> Gerak | <b>1-3</b> Ganti Scene | <b>KLIK</b> Cek Koordinat |
        <b>E</b> Interaksi
      </div>
    </div>

    <div id="info-overlay">
      <h2 id="info-title"></h2>
      <p id="info-desc"></p>
      <button class="close-btn" onclick="closePopup()">TUTUP</button>
    </div>

    <div id="joystick-zone"></div>

    <a-scene loading-screen="dotsColor: red; backgroundColor: black">
      <a-assets>
        <a-asset-item id="model-scene1" src="Scene 1.glb"></a-asset-item>
        <a-asset-item id="model-scene2" src="Scene 2.glb"></a-asset-item>
        <a-asset-item id="model-scene3" src="Scene 3.glb"></a-asset-item>
      </a-assets>

      <a-entity id="rig" position="0 0 0" rotation="0 0 0">
        <a-entity
          id="camera"
          camera
          look-controls="pointerLockEnabled: true"
          position="0 2.7 0"
        >
          <a-entity
            raycaster="objects: .clickable; far: 10; interval: 100"
            position="0 0 -1"
            geometry="primitive: ring; radiusInner: 0.001; radiusOuter: 0.001"
            material="color: black; shader: flat"
            id="cam-ray"
          >
          </a-entity>
        </a-entity>
      </a-entity>

      <a-sky color="#87CEEB"></a-sky>
      <a-light
        type="hemisphere"
        color="#ffffff"
        groundColor="#bbbbbb"
        intensity="1.5"
      ></a-light>
      <a-light type="directional" position="-2 10 4" intensity="0.5"></a-light>
      <a-light
        type="point"
        color="#fff"
        position="0 5 0"
        intensity="0.6"
        distance="30"
      ></a-light>

      <a-entity id="scene-container-1" visible="true">
        <a-entity
          gltf-model="#model-scene1"
          position="0 0 0"
          scale="1 1 1"
          class="clickable collidable"
        ></a-entity>
      </a-entity>

      <a-entity id="scene-container-2" visible="false">
        <a-entity
          gltf-model="#model-scene2"
          position="0 0 0"
          scale="1 1 1"
          class="clickable collidable"
        ></a-entity>
      </a-entity>

      <a-entity id="scene-container-3" visible="false">
        <a-entity
          gltf-model="#model-scene3"
          position="0 0 0"
          scale="1 1 1"
          class="clickable collidable"
        ></a-entity>
      </a-entity>

      <a-entity id="active-hitboxes"></a-entity>
    </a-scene>

    <script>
      /* --- 1. DATA CONFIGURATION --- */
      const itemDescriptions = {
        alarm: {
          t: "General Alarm",
          d: "Bunyikan alarm untuk memanggil semua kru.",
        },
        phone: {
          t: "Emergency Phone",
          d: "Gunakan untuk melapor ke kamar mesin.",
        },
        jacket: {
          t: "Life Jacket",
          d: "Gunakan Lifejacket saat keadaan darurat.",
        },
        muster: { t: "Muster Station", d: "Titik kumpul darurat semua kru." },
        mes: {
          t: "MES Container",
          d: "Unit MES. Tarik tuas untuk mengembangkan seluncuran.",
        },
        chute: {
          t: "Inflatable Chute",
          d: "Masuk ke seluncuran dengan posisi kaki menyilang.",
        },
        raft: {
          t: "Liferaft",
          d: "Rakit penolong yang sudah mengembang di air.",
        },
        tali: {
          t: "Tali Penahan (Bowsing Line)",
          d: "Tali ini menahan rakit agar tetap rapat dengan kapal untuk evakuasi.",
        },
      };

      // KONFIGURASI SCENE
      const scenes = {
        1: {
          name: "Bridge (Anjungan)",
          spawn: { x: 0.27, y: 0, z: -0.15 },
          rot: 0,
          containerId: "scene-container-1",
          hitboxes: [
            { pos: "4.13 2.69 3.92", key: "phone" },
            { pos: "1.80 2.00 5.25", key: "alarm" },
          ],
        },
        2: {
          name: "Scene 2 (Deck/Lobby)",
          spawn: { x: -7.64, y: 6.13, z: -7.94 },
          rot: 180,
          containerId: "scene-container-2",
          hitboxes: [
            { pos: "-9.44 8.17 -7.50", key: "raft" },
            { pos: "-5.21 8.08 -1.47", key: "jacket" },
            { pos: "-7.56 11.28 -4.72", key: "muster" },
            { pos: "-10.30 7.55 -2.92", key: "mes" },
          ],
        },
        3: {
          name: "Scene 3 (Evakuasi Laut)",
          spawn: { x: -7.5, y: 6.35, z: 1.94 },
          rot: 0,
          containerId: "scene-container-3",
          hitboxes: [
            { pos: "-10.30 6.84 -2.63", key: "chute" },
            { pos: "-15.35 1.24 -9.54", key: "raft", size: "3 2 3" },

            // --- UPDATED TALI POSITION DARI INSPECTOR BARU ---
            {
              // Position dari screenshot terakhir
              pos: "-11.782 7.739 -2.710",
              key: "tali",
              // Scale dari screenshot terakhir
              size: "0.100 1.610 0.100",
              // Rotation dari screenshot terakhir
              rot: "1.562 2.032 120.916",
            },
          ],
        },
      };

      let currentSceneIndex = 1;
      let verticalVelocity = 0;
      const GRAVITY = -0.015;

      /* --- 2. SCENE SWITCHER LOGIC --- */
      function loadScene(index) {
        if (!scenes[index]) return;

        console.log("Loading Scene " + index);
        currentSceneIndex = index;
        const config = scenes[index];

        document.getElementById("nav-info").innerText = "Loc: " + config.name;

        for (let key in scenes) {
          const el = document.getElementById(scenes[key].containerId);
          if (el) el.setAttribute("visible", key == index);
        }

        // Reset Physics
        verticalVelocity = 0;

        // Pindahkan Player
        const rig = document.getElementById("rig");
        rig.object3D.position.set(
          config.spawn.x,
          config.spawn.y,
          config.spawn.z
        );

        // Atur Rotasi
        const rotationY = (config.rot || 0) * (Math.PI / 180);
        rig.object3D.rotation.y = rotationY;

        // Load Hitbox
        const hitboxContainer = document.getElementById("active-hitboxes");
        hitboxContainer.innerHTML = "";

        config.hitboxes.forEach((item) => {
          createHitbox(item.pos, item.key, item.size, item.rot);
        });
      }

      function createHitbox(posStr, key, size = "0.5 0.5 0.5", rot = "0 0 0") {
        const el = document.createElement("a-entity");
        el.setAttribute("geometry", "primitive: box");

        // Set Ukuran (Scale)
        el.setAttribute("scale", size);

        // Set Rotasi
        el.setAttribute("rotation", rot);

        // Set Warna: CYAN (Biru Muda) agar kontras
        el.setAttribute(
          "material",
          "color: cyan; opacity: 0.4; transparent: true; depthTest: false"
        );

        el.setAttribute("position", posStr);
        el.setAttribute("class", "clickable");
        el.dataset.key = key;
        document.getElementById("active-hitboxes").appendChild(el);
      }

      /* --- 3. CONTROLS --- */
      const keys = { w: false, a: false, s: false, d: false };

      window.addEventListener("keydown", (e) => {
        const k = e.key.toLowerCase();

        if (k === "1") loadScene(1);
        if (k === "2") loadScene(2);
        if (k === "3") loadScene(3);

        if (keys.hasOwnProperty(k)) keys[k] = true;
        if (k === "e" && !isPopupOpen && focusedItem) showPopup();
        if (k === "escape") closePopup();
      });

      window.addEventListener("keyup", (e) => {
        const k = e.key.toLowerCase();
        if (keys.hasOwnProperty(k)) keys[k] = false;
      });

      /* --- 4. DEBUG KOORDINAT --- */
      window.addEventListener("click", () => {
        if (document.pointerLockElement) {
          const raycasterEl = document.getElementById("cam-ray");
          if (!raycasterEl.components.raycaster) return;
          const intersections = raycasterEl.components.raycaster.intersections;

          if (intersections.length > 0) {
            const point = intersections[0].point;
            const coordStr = `${point.x.toFixed(2)} ${point.y.toFixed(
              2
            )} ${point.z.toFixed(2)}`;
            console.log(
              `ðŸ“ SCENE ${currentSceneIndex} KOORDINAT: "${coordStr}"`
            );
            const msg = document.getElementById("interact-msg");
            msg.style.display = "block";
            msg.innerText = `KOORDINAT: ${coordStr}`;
            setTimeout(() => {
              if (msg.innerText.includes("KOORDINAT"))
                msg.style.display = "none";
            }, 3000);
          }
        }
      });

      /* --- 5. INTERACTION --- */
      let focusedItem = null;
      let isPopupOpen = false;
      const popup = document.getElementById("info-overlay");
      const ray = document.getElementById("cam-ray");
      const crosshair = document.getElementById("crosshair");
      const msg = document.getElementById("interact-msg");

      ray.addEventListener("raycaster-intersection", (evt) => {
        if (isPopupOpen) return;
        const el = evt.detail.els[0];
        if (el && el.dataset.key) {
          focusedItem = itemDescriptions[el.dataset.key];
          if (focusedItem) {
            crosshair.classList.add("active");
            msg.style.display = "block";
            msg.innerText = "TEKAN [E] : " + focusedItem.t;
          }
        }
      });

      ray.addEventListener("raycaster-intersection-cleared", () => {
        focusedItem = null;
        crosshair.classList.remove("active");
        if (!msg.innerText.includes("KOORDINAT")) msg.style.display = "none";
      });

      function showPopup() {
        if (!focusedItem) return;
        document.getElementById("info-title").innerText = focusedItem.t;
        document.getElementById("info-desc").innerText = focusedItem.d;
        popup.style.display = "block";
        isPopupOpen = true;
        document.exitPointerLock();
      }

      window.closePopup = function () {
        popup.style.display = "none";
        isPopupOpen = false;
        const sceneEl = document.querySelector("a-scene");
        if (sceneEl.canvas) sceneEl.canvas.requestPointerLock();
      };

      const startBtn = document.getElementById("start-btn");
      startBtn.addEventListener("click", function () {
        document.getElementById("start-screen").style.display = "none";
        loadScene(1);
        const sceneEl = document.querySelector("a-scene");
        if (sceneEl.canvas) sceneEl.canvas.requestPointerLock();
      });

      document.querySelector("a-scene").addEventListener("click", function () {
        if (!isPopupOpen) {
          const sceneEl = document.querySelector("a-scene");
          if (sceneEl.canvas) sceneEl.canvas.requestPointerLock();
        }
      });

      /* --- 6. MOVEMENT & PHYSICS LOOP --- */
      const rig = document.getElementById("rig");
      const cam = document.getElementById("camera");
      let joyData = null;

      const joyZone = document.getElementById("joystick-zone");
      if (joyZone) {
        const joy = nipplejs.create({
          zone: joyZone,
          mode: "static",
          position: { right: "50%", bottom: "50%" },
          color: "white",
        });
        joy.on("move", (e, data) => {
          joyData = data.vector;
        });
        joy.on("end", () => {
          joyData = null;
        });
      }

      const direction = new THREE.Vector3();
      const side = new THREE.Vector3();
      const moveVector = new THREE.Vector3();

      const collisionRay = new THREE.Raycaster();
      const floorRay = new THREE.Raycaster();
      const speed = 0.15;

      function loop() {
        if (!isPopupOpen) {
          cam.object3D.getWorldDirection(direction);
          direction.y = 0;
          direction.normalize();
          side.crossVectors(direction, new THREE.Vector3(0, 1, 0));
          moveVector.set(0, 0, 0);

          if (keys.w) moveVector.sub(direction);
          if (keys.s) moveVector.add(direction);
          if (keys.a) moveVector.add(side);
          if (keys.d) moveVector.sub(side);

          if (joyData) {
            const forward = direction.clone().multiplyScalar(-joyData.y);
            const sideways = side.clone().multiplyScalar(-joyData.x);
            moveVector.add(forward).add(sideways);
          }

          // COLLISION DETECTION (TEMBOK)
          const currentContainerId = scenes[currentSceneIndex].containerId;
          const activeModel = document.querySelector(
            `#${currentContainerId} .collidable`
          );
          let blocked = false;

          if (
            activeModel &&
            activeModel.object3D &&
            moveVector.lengthSq() > 0
          ) {
            const originPoint = rig.object3D.position.clone();
            originPoint.y += 0.5;
            const rayDir = moveVector.clone().normalize();
            collisionRay.set(originPoint, rayDir);
            collisionRay.far = 0.5;
            const intersects = collisionRay.intersectObjects(
              activeModel.object3D.children,
              true
            );
            if (intersects.length > 0) blocked = true;
          }

          if (!blocked && moveVector.lengthSq() > 0) {
            moveVector.normalize().multiplyScalar(speed);
            rig.object3D.position.add(moveVector);
          }

          // GRAVITY & FLOOR DETECTION
          verticalVelocity += GRAVITY;
          let onGround = false;

          if (activeModel && activeModel.object3D) {
            const rayOrigin = rig.object3D.position.clone();
            rayOrigin.y += 1.0;
            const down = new THREE.Vector3(0, -1, 0);

            floorRay.set(rayOrigin, down);
            const floorHits = floorRay.intersectObjects(
              activeModel.object3D.children,
              true
            );

            if (floorHits.length > 0) {
              const distanceToFloor = floorHits[0].distance;
              const floorY = floorHits[0].point.y;

              // Snap ke lantai jika dekat
              if (distanceToFloor <= 1.5 && verticalVelocity <= 0) {
                onGround = true;
                verticalVelocity = 0;
                rig.object3D.position.y = floorY;
              }
            }
          }

          if (!onGround) {
            rig.object3D.position.y += verticalVelocity;
          }

          // RESPAWN JIKA JATUH
          if (rig.object3D.position.y < -20) {
            loadScene(currentSceneIndex);
          }
        }
        requestAnimationFrame(loop);
      }
      loop();
    </script>
  </body>
</html>
